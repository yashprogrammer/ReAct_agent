name: Deploy to AWS EC2

on:
    push:
        branches: ["main"]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{github.repository}}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        
        steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Log in to the Container registry
          uses: docker/login-action@v2
          with:
            registry: ${{env.REGISTRY}}
            username: ${{github.actor}}
            password: ${{secrets.GITHUB_TOKEN}}

        - name: Extract metadata (tags, labels) for Docker
          id: meta
          uses: docker/metadata-action@v4
          with:
            images: ${{env.REGISTRY}}/${{env.IMAGE_NAME}}

        - name: Build and push Docker image
          uses: docker/build-push-action@v4
          with:
            context: .
            push: true
            tags: ${{steps.meta.outputs.tags}}
            labels: ${{steps.meta.outputs.labels}}

    deploy:
        runs-on: ubuntu-latest
        needs: build-and-push

        steps:
        - name: Checkout repository
          uses: appleboy/ssh-action@v1.0.0
          with:
            host: ${{secrets.HOST}}
            username: ${{secrets.USERNAME}}
            key: ${{secrets.SSH_KEY}}

            script:
                echo "${{secrets.CR_PAT}}" | docker login ghcr.io -u ${{secrets.USERNAME}} --password-stdin

                docker stop react_agent_container || true
                docker rm react_agent_container || true


                REPO_LOWER=$(echo "${{github.repository}}" | tr '[:upper:]' '[:lower:]')
                IMAGE_TAG=ghcr.io/$REPO_LOWER:main
                docker pull $IMAGE_TAG

                docker run -d \
                    --name react_agent_container \
                    -p 8000:8000 \
                    --restart unless-stopped \
                    -e GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}" \
                    -e GROQ_API_KEY="${{ secrets.GROQ_API_KEY }}" \
                    -e NOTION_API_KEY="${{ secrets.NOTION_API_KEY }}" \
                    -e NOTION_NOTES_DB_ID="${{ secrets.NOTION_NOTES_DB_ID }}" \
                    -e NOTION_CALENDAR_DB_ID="${{ secrets.NOTION_CALENDAR_DB_ID }}" \
                    $IMAGE_TAG


